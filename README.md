# bil-message

## Описание проекта

`bil-message` — это система защищённого обмена сообщениями между пользователями с поддержкой нескольких устройств на одного пользователя и энд-ту-энд шифрования (E2EE).  
Проект реализован по клиент-серверной архитектуре с использованием Go и PostgreSQL.

## Доступный функционал

1. Регистрация пользователя
2. Добавление устройства
3. Вход в аккаунт
4. Выход из аккаунта
5. Создание комнаты
6. Добавление пользователя в комнату
7. Удаление пользователя из комнаты
8. Общение в комнате (отправка и получение сообщений)

---

## Архитектура

### Серверная часть

Серверная часть реализована в Go и отвечает за:
- Аутентификацию и регистрацию пользователей.
- Управление устройствами: генерация и хранение публичных ключей каждого устройства пользователя.
- Создание комнат, управление членством и правами пользователей.
- Хранение зашифрованных ключей для каждого устройства (`room_keys`), используемых для расшифровки сообщений.
- Хранение сообщений в зашифрованном виде (`room_messages`), без доступа к расшифрованному контенту.
- Предоставление API для клиентских приложений (REST API с версией `/api/v1`).

Сервер поддерживает работу с несколькими устройствами на одного пользователя. Каждое устройство имеет уникальный идентификатор и публичный ключ. Сообщения шифруются на клиенте симметричным ключом для конкретного сообщения, а этот ключ затем шифруется публичными ключами всех устройств пользователя. Это позволяет каждому устройству безопасно расшифровать сообщение.

### Клиентская часть

Клиентская часть реализована в виде CLI-приложения:
- Позволяет регистрировать пользователя и входить в аккаунт.
- Позволяет добавлять новые устройства и синхронизировать ключи сообщений.
- Поддерживает создание комнат, добавление и удаление участников.
- Отправка и получение зашифрованных сообщений.
- Полностью совместим с E2EE: клиент шифрует сообщения симметричным ключом для конкретного сообщения, а расшифровка выполняется после получения с использованием приватного ключа устройства.

Клиент может запускаться на нескольких устройствах одновременно, синхронизируя ключи через сервер без раскрытия приватных ключей.

---

## База данных

![База данных](docs/db.png)


## Регистрация

![Регистрация](docs/register.png)

### Тест
Проверка корректной работы полного цикла регистрации пользователя через клиентский бинарник с реальным сервером и базой данных PostgreSQL. Тест гарантирует, что:  

1. Сервер корректно компилируется и запускается.  
2. Контейнер PostgreSQL поднимается и применяются миграции.  
3. Клиентский бинарник успешно отправляет запрос на регистрацию.  
4. Пользователь появляется в базе данных после регистрации.  

### Описание теста
1. **Компиляция бинарников**  
   - Сервер (`cmd/server`) и клиент (`cmd/client`) компилируются в временные файлы `/tmp/bil-server-test` и `/tmp/bil-client-test`.

2. **Поднятие контейнера PostgreSQL**  
   - Используется образ `postgres:15`.  
   - Создаётся база `testdb` с пользователем `postgres`.  
   - Контейнер ожидает готовности к подключению.  

3. **Применение миграций Goose**  
   - Путь к миграциям: `./migrations`.  
   - Применяются все миграции до последней версии.  

4. **Запуск сервера**  
   - Сервер стартует на случайном свободном порту.  
   - Ждём готовности сервера (пока он не начнёт слушать запросы).  

5. **Регистрация пользователя через клиентский бинарник**  
   - Клиент выполняет команду `register` с параметрами `--username` и `--password`.  
   - Проверяется успешный HTTP-ответ `200 OK`.  

6. **Проверка пользователя в базе**  
   - Подключение к PostgreSQL через `pgx`.  
   - Проверяется, что пользователь добавлен.  

7. **Завершение работы**  
   - Серверный процесс убивается.  
   - Контейнер PostgreSQL останавливается и удаляется.  

### Результат
- Пользователь успешно зарегистрирован, тест прошёл успешно.  
- Логи теста включают информацию о компиляции, запуске сервера, миграциях и результатах клиентского запроса.  

### Пример вывода

```
=== RUN   TestRegisterSuite
2025/08/23 09:45:33 [SetupSuite] Компиляция серверного бинарника...
2025/08/23 09:45:33 [SetupSuite] Серверный бинарник скомпилирован: /tmp/bil-server-test
2025/08/23 09:45:33 [SetupSuite] Клиентский бинарник скомпилирован: /tmp/bil-client-test
2025/08/23 09:45:33 [SetupSuite] Запуск контейнера PostgreSQL...
2025/08/23 09:45:35 [SetupSuite] Контейнер PostgreSQL поднят
2025/08/23 09:45:35 [SetupSuite] Postgres URL: postgres://postgres:postgres@localhost:32777/testdb?sslmode=disable
2025/08/23 09:45:35 [SetupSuite] Запуск миграций Goose...
2025/08/23 09:45:35 OK   0001_create_users.sql (13.01ms)
2025/08/23 09:45:35 OK   0002_create_user_devices.sql (19.74ms)
2025/08/23 09:45:35 OK   0003_create_rooms.sql (8.52ms)
2025/08/23 09:45:35 OK   0004_create_room_members.sql (8.15ms)
2025/08/23 09:45:35 OK   0005_create_room_messages.sql (10.56ms)
2025/08/23 09:45:35 OK   0006_create_room_keys.sql (10.53ms)
2025/08/23 09:45:35 goose: successfully migrated database to version: 6
2025/08/23 09:45:35 [SetupSuite] Миграции выполнены
2025/08/23 09:45:35 [SetupSuite] Сервер будет запущен на порту: :38391
2025/08/23 09:45:35 [SetupSuite] Запуск сервера...
2025/08/23 09:45:35 [SetupSuite] Сервер запущен
2025/08/23 09:45:35 Server build info:
2025/08/23 09:45:35   Version: N/A
2025/08/23 09:45:35   Commit:  N/A
2025/08/23 09:45:35   Date:    N/A
=== RUN   TestRegisterSuite/TestRegisterUser
2025/08/23 09:45:37 [TestRegisterUser] Запуск клиентского бинарника для регистрации...
2025/08/23 09:45:38 "POST http://localhost:38391/api/v1/auth/register HTTP/1.1" from 127.0.0.1:51124 - 200 36B in 86.439436ms
2025/08/23 09:45:38 [TestRegisterUser] Клиентский бинарник завершён. Output: 2025/08/23 09:45:37 Client build info:
2025/08/23 09:45:37   Version: N/A
2025/08/23 09:45:37   Commit:  N/A
2025/08/23 09:45:37   Date:    N/A
2025/08/23 09:45:38 5c53f57d-bd37-40b3-80a2-1fe5af5c3e62

2025/08/23 09:45:38 [TestRegisterUser] Проверка пользователя в базе...
2025/08/23 09:45:38 [TestRegisterUser] Пользователь успешно зарегистрирован
--- PASS: TestRegisterSuite/TestRegisterUser (0.11s)
2025/08/23 09:45:38 [TearDownSuite] Завершение работы сервера и контейнера...
2025/08/23 09:45:38 [TearDownSuite] Завершение завершено
--- PASS: TestRegisterSuite (4.73s)
PASS
ok      github.com/sbilibin2017/bil-message/tests/e2e   4.762s
```

## Добавление устройтсва

![Добавление устройтсва](docs/device.png)

## Вход в аккаунт

![Вход в аккаунт](docs/login.png)

## Выход из аккаунта

![Выход из аккаунта](docs/logout.png)

## Создание комнаты

![Создание комнаты](docs/room_create.png)

## Добавление пользователя в комнату

![Добавление пользователя в комнату](docs/room_add_member.png)

## Удаление пользователя из комнаты

![Удаление пользователя из комнаты](docs/room_remove_member.png)

## Общение в комнате

![Общение в комнате](docs/room_message.png)

