# bil-message

## Описание проекта

`bil-message` — это система защищённого обмена сообщениями между пользователями с поддержкой нескольких устройств на одного пользователя и энд-ту-энд шифрования (E2EE).  
Проект реализован по клиент-серверной архитектуре с использованием Go и PostgreSQL.

## Доступный функционал

1. Регистрация пользователя
2. Добавление устройства
3. Вход в аккаунт
4. Выход из аккаунта
5. Создание комнаты
6. Добавление пользователя в комнату
7. Удаление пользователя из комнаты
8. Общение в комнате (отправка и получение сообщений)

---

## Архитектура

### Серверная часть

Серверная часть реализована в Go и отвечает за:
- Аутентификацию и регистрацию пользователей.
- Управление устройствами: генерация и хранение публичных ключей каждого устройства пользователя.
- Создание комнат, управление членством и правами пользователей.
- Хранение зашифрованных ключей для каждого устройства (`room_keys`), используемых для расшифровки сообщений.
- Хранение сообщений в зашифрованном виде (`room_messages`), без доступа к расшифрованному контенту.
- Предоставление API для клиентских приложений (REST API с версией `/api/v1`).

Сервер поддерживает работу с несколькими устройствами на одного пользователя. Каждое устройство имеет уникальный идентификатор и публичный ключ. Сообщения шифруются на клиенте симметричным ключом для конкретного сообщения, а этот ключ затем шифруется публичными ключами всех устройств пользователя. Это позволяет каждому устройству безопасно расшифровать сообщение.

### Клиентская часть

Клиентская часть реализована в виде CLI-приложения:
- Позволяет регистрировать пользователя и входить в аккаунт.
- Позволяет добавлять новые устройства и синхронизировать ключи сообщений.
- Поддерживает создание комнат, добавление и удаление участников.
- Отправка и получение зашифрованных сообщений.
- Полностью совместим с E2EE: клиент шифрует сообщения симметричным ключом для конкретного сообщения, а расшифровка выполняется после получения с использованием приватного ключа устройства.

Клиент может запускаться на нескольких устройствах одновременно, синхронизируя ключи через сервер без раскрытия приватных ключей.

---

## База данных

![База данных](docs/db.png)


## Регистрация

![Регистрация](docs/register.png)

## Добавление устройтсва

![Добавление устройтсва](docs/device.png)

## Вход в аккаунт

![Вход в аккаунт](docs/login.png)

## Выход из аккаунта

![Выход из аккаунта](docs/logout.png)

## Создание комнаты

![Создание комнаты](docs/room_create.png)

## Добавление пользователя в комнату

![Добавление пользователя в комнату](docs/room_add_member.png)

## Удаление пользователя из комнаты

![Удаление пользователя из комнаты](docs/room_remove_member.png)

## Общение в комнате

![Общение в комнате](docs/room_message.png)

---

## Тестирование

Проект содержит E2E-тесты (end-to-end), которые проверяют основные сценарии работы системы через клиентское и серверное приложения.  
Тесты обеспечивают проверку функциональности на уровне всего стека: от регистрации пользователя до отправки сообщений в комнатах.

### Основные сценарии, покрываемые тестами

1. **Регистрация пользователя**  
   - Проверяется успешная регистрация нового пользователя.
   - Подтверждается наличие пользователя в базе данных после регистрации.   

2. **Добавление устройства**  
   - Проверяется добавление нового устройства для пользователя.
   - UUID устройства сохраняется локально в конфигурационном файле клиента (`~/.config/bil_message_client_device_uuid`).
   - Проверяется, что добавленное устройство корректно зарегистрировано на сервере.

3. **Вход в аккаунт (Login)**  
   - Выполняется вход пользователя с указанием конкретного устройства.
   - Проверяется генерация JWT токена для аутентификации.
   - Тест проверяет корректность токена и соответствие устройства пользователю.

### Реализация тестов

- Тесты используют **Testcontainers** для поднятия PostgreSQL в контейнере, чтобы создать изолированную базу данных для каждого запуска.
- Для серверной и клиентской части компилируются бинарники на лету.
- Тесты выполняются через CLI клиента, имитируя реальные пользовательские сценарии.
- Для каждого теста генерируется уникальный пользователь, что исключает конфликты при повторном запуске.

## Серверный бинарник

Серверная часть доступна в виде готового бинарника для Linux (amd64):

| Платформа     | Путь к бинарнику                                   |
|--------------|---------------------------------------------------|
| Linux (amd64) | `builds/server/bil-message-server-linux-amd64`  |

## Клиентские бинарники

Клиентская часть доступна в виде готовых бинарников для основных платформ:

| Платформа       | Путь к бинарнику                                      |
|-----------------|------------------------------------------------------|
| Linux (amd64)   | `builds/clients/bil-message-client-linux-amd64`     |
| MacOS (amd64)   | `builds/clients/bil-message-client-macos-amd64`     |
| Windows (amd64) | `builds/clients/bil-message-client-windows-amd64.exe` |

## Установка CLI клиента `bil-message-client`

| Шаг | Команда | Описание |
|-----|---------|----------|
| 1   | `cp builds/clients/bil-message-client-linux-amd64 $HOME/.local/bin/bil-message-client` | Копирование бинарника для Linux в директорию локальных бинарников (замените на соответствующий для вашей ОС) |
| 2   | `chmod +x $HOME/.local/bin/bil-message-client` | Сделать бинарник исполняемым (только Linux/MacOS) |
| 3   | `echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.bashrc` <br> `source ~/.bashrc` | Добавление директории с бинарником в PATH, чтобы запускать клиента из любого места (для Zsh используйте `~/.zshrc`) |
| 4   | `bil-message-client version` | Проверка установки, вывод версии клиента, хэша коммита и даты сборки |

