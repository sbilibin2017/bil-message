@startuml
!define table(x) class x << (T,#FFAAAA) >>

skinparam linetype ortho

table(users) {
    <u>user_uuid</u> : UUID
    username : VARCHAR(50)    
    password_hash : VARCHAR(255)
    public_key : TEXT
    created_at : TIMESTAMP
    updated_at : TIMESTAMP
}

table(devices) {
    <u>device_uuid</u> : UUID
    user_uuid : UUID
    public_key : TEXT
    created_at : TIMESTAMP
    updated_at : TIMESTAMP
}

table(chat_types) {
    <u>chat_type_uuid</u> : UUID
    name : VARCHAR(50)
    description : TEXT
}

table(chats) {
    <u>chat_uuid</u> : UUID
    name : VARCHAR(100)
    type_uuid : UUID
    created_by_uuid : UUID
    created_at : TIMESTAMP
    updated_at : TIMESTAMP
}

table(chat_members) {
    <u>chat_member_uuid</u> : UUID
    chat_uuid : UUID
    user_uuid : UUID
    role : VARCHAR(20)
    joined_at : TIMESTAMP
}

table(messages) {
    <u>message_uuid</u> : UUID
    chat_uuid : UUID
    sender_uuid : UUID
    encrypted_text : TEXT
    created_at : TIMESTAMP    
}

table(message_keys) {
    <u>message_key_uuid</u> : UUID
    message_uuid : UUID
    device_uuid : UUID
    encrypted_symmetric_key : TEXT
    created_at : TIMESTAMP
}

table(message_reads) {
    <u>message_read_uuid</u> : UUID
    message_uuid : UUID
    user_uuid : UUID
    read_at : TIMESTAMP
}

' Связи
users "1" --> "0..*" devices : user_uuid
users "1" --> "0..*" chats : created_by_uuid
users "1" --> "0..*" chat_members : user_uuid
users "1" --> "0..*" messages : sender_uuid
users "1" --> "0..*" message_reads : user_uuid

devices "1" --> "0..*" message_keys : device_uuid

chats "1" --> "0..*" chat_members : chat_uuid
chats "1" --> "0..*" messages : chat_uuid
chats "1" --> "1" chat_types : type_uuid

messages "1" --> "0..*" message_keys : message_uuid
messages "1" --> "0..*" message_reads : message_uuid

@enduml