@startuml
skinparam linetype ortho
skinparam packageStyle rectangle

' --- таблицы ---
class User {
  +user_uuid : UUID <<PK>>
  username : varchar
  password_hash : text
  created_at : timestamp
}

class UserDevice {
  +user_device_uuid : UUID <<PK>>
  user_uuid : UUID <<FK to User.user_uuid>>
  device_name : varchar
  public_key : bytea
  created_at : timestamp
}

class Room {
  +room_uuid : UUID <<PK>>
  name : varchar
  created_by : UUID <<FK to User.user_uuid>>
  created_at : timestamp
}

class RoomMember {
  +room_uuid : UUID <<FK to Room.room_uuid>>
  +user_uuid : UUID <<FK to User.user_uuid>>
  role : varchar
  joined_at : timestamp
}

class RoomKey {
  +room_uuid : UUID <<FK to Room.room_uuid>>
  +user_device_uuid : UUID <<FK to UserDevice.user_device_uuid>>
  ephemeral_pub : bytea
  nonce : bytea
  wrapped_key : bytea
  created_at : timestamp
}

class Message {
  +message_uuid : UUID <<PK>>
  room_uuid : UUID <<FK to Room.room_uuid>>
  user_uuid : UUID <<FK to User.user_uuid>>
  ciphertext : text
  nonce : bytea
  created_at : timestamp
}

' --- связи ---
User -right-> UserDevice : "has"
User -down-> RoomMember : "joins"
User -down-> Message : "sends"
User -right-> Room : "creates"

Room -down-> RoomMember : "has"
Room -down-> RoomKey : "encrypts"
Room -down-> Message : "contains"

UserDevice -right-> RoomKey : "stores"
@enduml
